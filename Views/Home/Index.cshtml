@model IEnumerable<dynamic>

@using (Html.BeginForm("Index", "Home", FormMethod.Get))
{
    <div class="form-group">
        <label for="startDate">Выберите месяц и год:</label>
        <input type="month" id="startDate" name="startDate" class="form-control" />
    </div>
    @if (User.IsInRole("Admin"))
    {
        <div class="form-group">
            <label for="users">Пользователи:</label>
            <select id="users" name="users" class="form-control" multiple>
                <option value="all">Все пользователи</option>
                @foreach (var user in ViewBag.Users)
                {
                    <option value="@user.Id">@user.UserName</option>
                }
            </select>
        </div>
    }
    <button type="submit" class="btn btn-primary">Применить фильтры</button>
    <button type="submit" class="btn btn-secondary" name="reset" value="true">Сбросить фильтры</button>
    <p>&nbsp;</p>
}

<div class="content-viewport">
    <div id="salesChart" style="width:100%; height:400px;"></div>
</div>

@section Scripts {
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var salesData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
            var startDate = '@ViewBag.StartDate';

            // Определяем, были ли применены фильтры
            var isFiltered = startDate !== '';

            if (isFiltered) {
                // Если фильтр по месяцу применен, создаем метки дней выбранного месяца
                var labels = [...new Set(salesData.map(s => s.Day))].sort((a, b) => a - b);

                var users = [...new Set(salesData.map(s => s.UserName))];
                var series = users.map(user => {
                    var userSalesData = salesData.filter(s => s.UserName === user);
                    var data = labels.map(day => {
                        var dayData = userSalesData.find(s => s.Day == day);
                        return dayData ? dayData.TotalSales : 0;
                    });
                    return {
                        name: user,
                        data: data
                    };
                });

                Highcharts.chart('salesChart', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'Продажи по дням за выбранный месяц'
                    },
                    xAxis: {
                        categories: labels.map(day => `День ${day}`),
                        title: {
                            text: 'День месяца'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Сумма продаж'
                        },
                        min: 0
                    },
                    series: series,
                    tooltip: {
                        shared: true,
                        crosshairs: true,
                        formatter: function () {
                            return `${this.points[0].key}:<br>` +
                                this.points.map(point => `<b>${point.series.name}:</b> ${point.y}`).join('<br>');
                        }
                    }
                });
            } else {
                // Если фильтр по месяцу не применен, создаем метки месяцев и годов
                var labels = [...new Set(salesData.map(s => `${s.Year}-${('0' + s.Month).slice(-2)}`))].sort();

                var users = [...new Set(salesData.map(s => s.UserName))];
                var series = users.map(user => {
                    var userSalesData = salesData.filter(s => s.UserName === user);
                    var data = labels.map(label => {
                        var [year, month] = label.split('-');
                        var monthData = userSalesData.find(s => s.Year == year && ('0' + s.Month).slice(-2) == month);
                        return monthData ? monthData.TotalSales : 0;
                    });
                    return {
                        name: user,
                        data: data
                    };
                });

                Highcharts.chart('salesChart', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'Продажи по месяцам за все время'
                    },
                    xAxis: {
                        categories: labels,
                        title: {
                            text: 'Месяц'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Сумма продаж'
                        },
                        min: 0
                    },
                    series: series,
                    tooltip: {
                        shared: true,
                        crosshairs: true,
                        formatter: function () {
                            return `${this.points[0].key}:<br>` +
                                this.points.map(point => `<b>${point.series.name}:</b> ${point.y}`).join('<br>');
                        }
                    }
                });
            }
        });
    </script>
}
